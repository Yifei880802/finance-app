<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆChart.jsæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            margin: 20px;
            background: #1C1C1E;
            color: white;
        }
        .section {
            background: #2C2C2E;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .success { background: rgba(72, 187, 120, 0.2); color: #48BB78; }
        .error { background: rgba(245, 101, 101, 0.2); color: #F56565; }
        .warning { background: rgba(237, 137, 54, 0.2); color: #ED8936; }
        .log {
            background: #1A1A1A;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5a67d8; }
        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
        }
        canvas {
            width: 100%;
            max-width: 400px;
            height: 200px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š æœ€ç»ˆChart.jsåŠ è½½æµ‹è¯•</h1>
    
    <div class="section">
        <h3>åŠ è½½çŠ¶æ€</h3>
        <div id="loadStatus" class="status warning">æ­£åœ¨æ£€æŸ¥...</div>
        <button onclick="testAll()">å®Œæ•´æµ‹è¯•</button>
        <button onclick="window.reloadChartJs && window.reloadChartJs()">å¼ºåˆ¶é‡æ–°åŠ è½½</button>
    </div>
    
    <div class="section">
        <h3>å›¾è¡¨æµ‹è¯•</h3>
        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
        <button onclick="createChart()">åˆ›å»ºå›¾è¡¨</button>
    </div>
    
    <div class="section">
        <h3>è¯¦ç»†æ—¥å¿—</h3>
        <div id="log" class="log">ç­‰å¾…æµ‹è¯•...</div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- ä½¿ç”¨æˆ‘ä»¬åˆšåˆšä¼˜åŒ–çš„Chart.jsåŠ è½½è„šæœ¬ -->
    <script>
        // Chart.js åº“åŠ è½½çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
        (function() {
            // é¦–å…ˆå°è¯•æœ¬åœ°åŠ è½½ï¼Œå†å°è¯•ç½‘ç»œåŠ è½½
            const chartjsUrls = [
                // å°è¯•æ›´ç¨³å®šçš„CDN
                'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js',
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js',
                
                // æ›´æ—©æœŸçš„ç¨³å®šç‰ˆæœ¬
                'https://unpkg.com/chart.js@4.3.3/dist/chart.umd.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.3/chart.umd.js',
                'https://cdn.jsdelivr.net/npm/chart.js@4.3.3/dist/chart.umd.js',
                
                // æ›´æ—©æœŸçš„ç‰ˆæœ¬
                'https://unpkg.com/chart.js@4.2.1/dist/chart.umd.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.js'
            ];
            
            let currentIndex = 0;
            let isLoading = false;
            let loadAttempts = 0;
            const maxAttempts = chartjsUrls.length;
            let fallbackMode = false;
            
            // å¢å¼ºçš„Chart.jsæ£€æŸ¥å‡½æ•°
            function checkChartLoaded() {
                try {
                    return typeof Chart !== 'undefined' && 
                           Chart.version && 
                           typeof Chart.Chart !== 'undefined';
                } catch (e) {
                    return false;
                }
            }
            
            function notifySuccess() {
                addLog('âœ… Chart.jsåº“æœ€ç»ˆåŠ è½½æˆåŠŸï¼');
                addLog('ğŸ“ˆ Chart.jsç‰ˆæœ¬: ' + Chart.version);
                window.chartJsLoaded = true;
                window.chartJsLoadError = false;
                updateStatus('âœ… Chart.jsåŠ è½½æˆåŠŸ', 'success');
                
                // è§¦å‘åŠ è½½æˆåŠŸäº‹ä»¶
                try {
                    window.dispatchEvent(new CustomEvent('chartJsLoaded', {
                        detail: { version: Chart.version }
                    }));
                } catch (e) {
                    addLog('äº‹ä»¶è§¦å‘å¤±è´¥: ' + e);
                }
            }
            
            function createMockChart() {
                addLog('ğŸ¨ å¯ç”¨æ¨¡æ‹Ÿå›¾è¡¨æ¨¡å¼');
                
                // åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„Mock Chartå¯¹è±¡
                window.Chart = function(ctx, config) {
                    this.canvas = ctx.canvas;
                    this.config = config;
                    this.data = config.data;
                    this.options = config.options;
                    
                    // åˆ›å»ºç®€å•çš„è§†è§‰è¡¨ç¤º
                    this.render = function() {
                        const canvas = this.canvas;
                        const ctx = canvas.getContext('2d');
                        
                        // æ¸…ç©ºç”»å¸ƒ
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // è®¾ç½®èƒŒæ™¯
                        ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // æ˜¾ç¤ºæç¤ºæ–‡å­—
                        ctx.fillStyle = '#667eea';
                        ctx.font = '16px SF Pro Display, system-ui, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('ğŸ“ˆ å›¾è¡¨æ•°æ®æ˜¾ç¤º', canvas.width / 2, canvas.height / 2 - 20);
                        
                        ctx.fillStyle = '#8E8E93';
                        ctx.font = '12px SF Pro Display, system-ui, sans-serif';
                        ctx.fillText('ç¦»çº¿æ¨¡æ‹Ÿæ¨¡å¼', canvas.width / 2, canvas.height / 2 + 10);
                        
                        // ç»˜åˆ¶ç®€å•çš„æ•°æ®çº¿
                        if (this.data && this.data.datasets) {
                            ctx.strokeStyle = '#60a5fa';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(50, canvas.height - 50);
                            ctx.lineTo(150, canvas.height - 80);
                            ctx.lineTo(250, canvas.height - 60);
                            ctx.lineTo(350, canvas.height - 90);
                            ctx.stroke();
                        }
                    };
                    
                    this.destroy = function() {
                        if (this.canvas) {
                            const ctx = this.canvas.getContext('2d');
                            ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        }
                    };
                    
                    // ç«‹å³æ¸²æŸ“
                    setTimeout(() => this.render(), 100);
                };
                
                // æ·»åŠ åŸºæœ¬å±æ€§
                window.Chart.version = '4.x-mock';
                window.Chart.Chart = window.Chart;
                window.Chart.defaults = {
                    responsive: true,
                    maintainAspectRatio: false
                };
                
                fallbackMode = true;
                window.chartJsLoaded = true;
                window.chartJsLoadError = false;
                updateStatus('ğŸ¨ æ¨¡æ‹Ÿæ¨¡å¼å·²å¯ç”¨', 'warning');
                
                // è§¦å‘äº‹ä»¶
                try {
                    window.dispatchEvent(new CustomEvent('chartJsLoaded', {
                        detail: { version: 'mock', fallback: true }
                    }));
                } catch (e) {
                    addLog('äº‹ä»¶è§¦å‘å¤±è´¥: ' + e);
                }
                
                addLog('ğŸ¨ æ¨¡æ‹Ÿå›¾è¡¨æ¨¡å¼å·²å¯ç”¨');
            }
            
            function notifyFailure() {
                addLog('âŒ æ‰€æœ‰Chart.js CDNéƒ½åŠ è½½å¤±è´¥ï¼');
                addLog('ğŸ¨ å°è¯•å¯ç”¨æ¨¡æ‹Ÿå›¾è¡¨æ¨¡å¼...');
                updateStatus('âš ï¸ å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼', 'warning');
                
                // å°è¯•å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                setTimeout(createMockChart, 500);
            }
            
            function loadChartJs() {
                // é˜²æ­¢é‡å¤åŠ è½½
                if (isLoading) {
                    addLog('ğŸ”„ Chart.jsæ­£åœ¨åŠ è½½ä¸­...');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
                if (checkChartLoaded()) {
                    addLog('âœ… Chart.jså·²å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½');
                    notifySuccess();
                    return;
                }
                
                if (currentIndex >= chartjsUrls.length) {
                    notifyFailure();
                    return;
                }
                
                isLoading = true;
                loadAttempts++;
                
                const currentUrl = chartjsUrls[currentIndex];
                addLog(`ğŸ“¦ åŠ è½½Chart.js [${loadAttempts}/${maxAttempts}]: ${currentUrl}`);
                
                const script = document.createElement('script');
                script.src = currentUrl;
                script.async = true; // æ”¹ä¸ºå¼‚æ­¥åŠ è½½
                script.crossOrigin = 'anonymous';
                script.type = 'text/javascript';
                
                let hasTimedOut = false;
                
                // ç¼©çŸ­è¶…æ—¶æ—¶é—´
                const timeout = setTimeout(() => {
                    if (isLoading && !checkChartLoaded()) {
                        addLog(`â° Chart.jsåŠ è½½è¶…æ—¶: ${currentUrl}`);
                        hasTimedOut = true;
                        isLoading = false;
                        currentIndex++;
                        setTimeout(loadChartJs, 50); // ç¼©çŸ­é‡è¯•é—´éš”
                    }
                }, 3000); // ç¼©çŸ­ä¸º3ç§’è¶…æ—¶
                
                script.onload = function() {
                    clearTimeout(timeout);
                    if (hasTimedOut) return;
                    
                    // ç»™æµè§ˆå™¨ä¸€äº›æ—¶é—´æ¥æ‰§è¡Œè„šæœ¬
                    setTimeout(() => {
                        if (checkChartLoaded()) {
                            addLog(`âœ… Chart.jsåŠ è½½æˆåŠŸ: ${currentUrl}`);
                            isLoading = false;
                            notifySuccess();
                        } else {
                            addLog(`âš ï¸ è„šæœ¬åŠ è½½ä½†Chartå¯¹è±¡ä¸å¯ç”¨: ${currentUrl}`);
                            isLoading = false;
                            currentIndex++;
                            setTimeout(loadChartJs, 100);
                        }
                    }, 100); // ç¼©çŸ­ç­‰å¾…æ—¶é—´
                };
                
                script.onerror = function() {
                    clearTimeout(timeout);
                    if (hasTimedOut) return;
                    
                    addLog(`âš ï¸ Chart.jsåŠ è½½å¤±è´¥: ${currentUrl}`);
                    isLoading = false;
                    currentIndex++;
                    setTimeout(loadChartJs, 100); // ç¼©çŸ­é‡è¯•é—´éš”
                };
                
                // æ·»åŠ åˆ°æ–‡æ¡£
                try {
                    document.head.appendChild(script);
                } catch (e) {
                    addLog('æ— æ³•æ·»åŠ è„šæœ¬æ ‡ç­¾: ' + e);
                    clearTimeout(timeout);
                    isLoading = false;
                    currentIndex++;
                    setTimeout(loadChartJs, 50);
                }
            }
            
            // å…¨å±€é‡æ–°åŠ è½½å‡½æ•°
            window.reloadChartJs = function() {
                addLog('ğŸ”„ å¼ºåˆ¶é‡æ–°åŠ è½½Chart.js...');
                currentIndex = 0;
                isLoading = false;
                loadAttempts = 0;
                fallbackMode = false;
                window.chartJsLoaded = false;
                window.chartJsLoadError = false;
                updateStatus('ğŸ”„ é‡æ–°åŠ è½½ä¸­...', 'warning');
                
                // æ¸…ç†ç°æœ‰çš„Chartå¯¹è±¡
                if (typeof Chart !== 'undefined') {
                    try {
                        delete window.Chart;
                    } catch (e) {
                        window.Chart = undefined;
                    }
                }
                
                loadChartJs();
            };
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç¯å¢ƒä¸­æˆ–ç½‘ç»œä¸å¯ç”¨
            function checkNetworkAndStart() {
                // å°è¯•åŠ è½½ä¸€ä¸ªå°çš„æµ‹è¯•å›¾ç‰‡æ¥æ£€æŸ¥ç½‘ç»œ
                const testImage = new Image();
                testImage.onload = function() {
                    addLog('ğŸŒ ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå¼€å§‹åŠ è½½Chart.js');
                    loadChartJs();
                };
                testImage.onerror = function() {
                    addLog('ğŸš… ç½‘ç»œè¿æ¥ä¸ä½³ï¼Œç›´æ¥å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
                    setTimeout(createMockChart, 1000);
                };
                testImage.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/package.json';
                
                // å¦‚æœ2ç§’å†…æ²¡æœ‰å“åº”ï¼Œç›´æ¥å¼€å§‹åŠ è½½
                setTimeout(() => {
                    if (!window.chartJsLoaded && !isLoading) {
                        addLog('ğŸš€ è¶…æ—¶æ£€æŸ¥ï¼Œç›´æ¥å¼€å§‹åŠ è½½');
                        loadChartJs();
                    }
                }, 2000);
            }
            
            // å¼€å§‹åŠ è½½
            addLog('ğŸš€ åˆå§‹åŒ–Chart.jsåŠ è½½ç³»ç»Ÿ...');
            checkNetworkAndStart();
        })();
    </script>
    
    <script>
        let logs = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            const logEl = document.getElementById('log');
            logEl.textContent = logs.join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            logs = [];
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º';
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('loadStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function testAll() {
            addLog('ğŸ§ª å¼€å§‹å®Œæ•´æµ‹è¯•...');
            
            // æ£€æŸ¥Chart.js
            const isLoaded = typeof Chart !== 'undefined';
            const hasVersion = isLoaded && Chart.version;
            
            if (isLoaded && hasVersion) {
                addLog(`âœ… Chart.jsçŠ¶æ€æ­£å¸¸ï¼Œç‰ˆæœ¬: ${Chart.version}`);
                updateStatus(`âœ… Chart.jsæ­£å¸¸ (${Chart.version})`, 'success');
                
                // æµ‹è¯•å›¾è¡¨åˆ›å»º
                createChart();
            } else if (isLoaded && !hasVersion) {
                addLog('âš ï¸ Chart.jså¯¹è±¡å­˜åœ¨ä½†ç‰ˆæœ¬ä¿¡æ¯ç¼ºå¤±');
                updateStatus('âš ï¸ Chart.jsåŠ è½½ä¸å®Œæ•´', 'warning');
            } else {
                addLog('âŒ Chart.jsåº“æœªåŠ è½½æˆ–ä¸å¯ç”¨');
                updateStatus('âŒ Chart.jsæœªåŠ è½½', 'error');
            }
        }
        
        function createChart() {
            addLog('ğŸ“ˆ å°è¯•åˆ›å»ºæµ‹è¯•å›¾è¡¨...');
            
            if (typeof Chart === 'undefined') {
                addLog('âŒ æ— æ³•åˆ›å»ºå›¾è¡¨ï¼šChart.jsåº“æœªå°±ç»ª');
                return;
            }
            
            const canvas = document.getElementById('testChart');
            const ctx = canvas.getContext('2d');
            
            try {
                // é”€æ¯ç°æœ‰å›¾è¡¨
                if (window.testChartInstance) {
                    window.testChartInstance.destroy();
                }
                
                // åˆ›å»ºç®€å•çš„æµ‹è¯•å›¾è¡¨
                window.testChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ'],
                        datasets: [{
                            label: 'æµ‹è¯•æ•°æ®',
                            data: [12000, 19000, 15000, 25000, 22000],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: { 
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
                
                addLog('âœ… æµ‹è¯•å›¾è¡¨åˆ›å»ºæˆåŠŸï¼');
                updateStatus('âœ… å›¾è¡¨åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');
                
            } catch (error) {
                addLog(`âŒ åˆ›å»ºå›¾è¡¨å¤±è´¥: ${error.message}`);
                updateStatus('âŒ å›¾è¡¨åˆ›å»ºå¤±è´¥', 'error');
            }
        }
        
        // ç›‘å¬Chart.jsåŠ è½½äº‹ä»¶
        window.addEventListener('chartJsLoaded', function(event) {
            addLog('ğŸ‰ æ”¶åˆ°Chart.jsåŠ è½½å®Œæˆäº‹ä»¶');
            setTimeout(testAll, 500);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥...');
            setTimeout(testAll, 2000);
        });
    </script>
</body>
</html>